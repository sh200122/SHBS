{"version":3,"file":"index.js","sources":["../src/resolve.ts","../src/program.ts","../src/index.ts"],"sourcesContent":["import * as resolve from 'resolve'\n\nexport function resolveSync (\n  id: string,\n  opts: resolve.SyncOpts = {\n    basedir: __dirname,\n  }\n) {\n  return resolve.sync(id, opts)\n}\n","import path from 'node:path'\n\nimport { TaroPlatformWeb } from '@tarojs/service'\n\nimport { resolveSync } from './resolve'\n\nimport type { IPluginContext, TConfig } from '@tarojs/service'\n\nconst compLibraryAlias = {\n  vue3: 'vue3',\n}\n\nconst PACKAGE_NAME = '@tarojs/plugin-platform-harmony-hybrid'\nexport default class H5 extends TaroPlatformWeb {\n  platform = 'harmony-hybrid'\n  runtimePath = `${PACKAGE_NAME}/dist/runtime`\n\n  constructor (ctx: IPluginContext, config: TConfig) {\n    super(ctx, config)\n    this.setupTransaction.addWrapper({\n      close () {\n        this.modifyWebpackConfig()\n      },\n    })\n  }\n\n  get framework () {\n    return this.ctx.initialConfig.framework || 'react'\n  }\n\n  get useHtmlComponents () {\n    return !!this.ctx.initialConfig.h5?.useHtmlComponents\n  }\n\n  get useDeprecatedAdapterComponent () {\n    return !!this.ctx.initialConfig.h5?.useDeprecatedAdapterComponent\n  }\n\n  get apiLibrary () {\n    return require.resolve('./runtime/apis')\n  }\n\n  get aliasFramework (): string {\n    return compLibraryAlias[this.framework] || 'react'\n  }\n\n  get componentLibrary () {\n    if (this.useHtmlComponents && this.aliasFramework === 'react') {\n      return require.resolve('./runtime/components')\n    } else if (this.useDeprecatedAdapterComponent) {\n      return require.resolve(`@tarojs/components/lib/${this.aliasFramework}/component-lib`)\n    } else {\n      return require.resolve(`@tarojs/plugin-platform-harmony-hybrid/dist/components/${this.aliasFramework}`)\n    }\n  }\n\n  get componentAdapter () {\n    return path.join(path.dirname(require.resolve('@tarojs/components')), '..', 'lib')\n  }\n\n  get routerLibrary () {\n    return require.resolve('@tarojs/router')\n  }\n\n  get libraryDefinition () {\n    return resolveSync('./definition.json')\n  }\n\n  /**\n   * 修改 Webpack 配置\n   */\n  modifyWebpackConfig () {\n    this.ctx.modifyWebpackChain(({ chain }) => {\n      const rules = chain.module.rules\n      const script = rules.get('script')\n      const babelLoader = script.uses.get('babelLoader')\n      const routerApis = new Set(['navigateTo', 'navigateBack', 'redirectTo', 'reLaunch', 'switchTab'])\n      let apis = require(resolveSync('./taroApis'))\n      apis = new Set(Array.from(apis).filter((x: string) => !routerApis.has(x)))\n      babelLoader.set('options', {\n        ...babelLoader.get('options'),\n        plugins: [\n          [\n            require('babel-plugin-transform-taroapi'),\n            {\n              packageName: '@tarojs/taro',\n              apis,\n              definition: require(this.libraryDefinition),\n            },\n          ],\n        ],\n      })\n\n      const alias = chain.resolve.alias\n      // TODO 考虑集成到 taroComponentsPath 中，与小程序端对齐\n      alias.set('@tarojs/components$', this.componentLibrary)\n      alias.set('@tarojs/components/lib', this.componentAdapter)\n      alias.set('@tarojs/router$', this.routerLibrary)\n      alias.set('@tarojs/taro', this.apiLibrary)\n      chain.plugin('mainPlugin').tap((args) => {\n        args[0].loaderMeta ||= {\n          extraImportForWeb: '',\n          execBeforeCreateWebApp: '',\n        }\n\n        // Note: 旧版本适配器不会自动注册 Web Components 组件，需要加载 defineCustomElements 脚本自动注册使用的组件\n        if (this.useDeprecatedAdapterComponent) {\n          args[0].loaderMeta.extraImportForWeb += `import { applyPolyfills, defineCustomElements } from '@tarojs/components/loader'\\n`\n          args[0].loaderMeta.execBeforeCreateWebApp += `applyPolyfills().then(() => defineCustomElements(window))\\n`\n        }\n\n        if (!this.useHtmlComponents) {\n          args[0].loaderMeta.extraImportForWeb += `import { defineCustomElementTaroPullToRefreshCore } from '@tarojs/components/dist/components'\\n`\n          args[0].loaderMeta.execBeforeCreateWebApp += `defineCustomElementTaroPullToRefreshCore()\\n`\n        }\n\n        switch (this.framework) {\n          case 'vue3':\n            args[0].loaderMeta.extraImportForWeb += `import { initVue3Components } from '@tarojs/components/lib/vue3/components-loader'\\nimport * as list from '@tarojs/components'\\n`\n            args[0].loaderMeta.execBeforeCreateWebApp += `initVue3Components(component, list)\\n`\n            break\n          default:\n            if (this.useHtmlComponents) {\n              args[0].loaderMeta.extraImportForWeb += `import '${require.resolve(\n                '@tarojs/components-react/dist/index.css'\n              )}'\\nimport { PullDownRefresh } from '@tarojs/components'\\n`\n              args[0].loaderMeta.execBeforeCreateWebApp += `config.PullDownRefresh = PullDownRefresh\\n`\n            }\n        }\n        return args\n      })\n\n      // 修改htmlWebpackPlugin插件的script脚本\n      chain.plugin('htmlWebpackPlugin').tap((args) => {\n        const options = this.config?.postcss?.pxtransform?.config || {}\n        // const max = options?.maxRootSize ?? 40\n        // const min = options?.minRootSize ?? 20\n        const baseFontSize = options?.baseFontSize || 20// (min > 1 ? min : 20)\n        const designWidth = (input => typeof this.config.designWidth === 'function'\n          ? this.config.designWidth(input)\n          : this.config.designWidth)(baseFontSize)\n        const rootValue = baseFontSize / this.config.deviceRatio![designWidth!] * 2\n        let htmlScript = ''\n        if ((this.config?.targetUnit ?? 'rem') === 'rem') {\n          /**\n           * 缩放策略为：\n           * 1. 手机-竖屏，缩放策略为“自动缩放”\n           * 2. 折叠屏、Pad竖屏，缩放策略为“依据设计尺寸，大小不变”\n           * 3. Pad(模屏)、2in1(默认)，缩放策略为“依据设计尺寸，大小不变”\n           * 4. 2in1（全屏），缩放策略为“依据设计尺寸，大小不变”\n           */\n          htmlScript = `!function(n){function f(){var e=n.document.documentElement;var w=Math.floor(e.getBoundingClientRect().width);if(w<600){var x=${rootValue}*w/${designWidth};e.style.fontSize=x+\"px\"}else if(w<840){w=${designWidth}/2;var x=${rootValue}*w/${designWidth};e.style.fontSize=x+\"px\"}else if(w<1440){w=${designWidth}/2;var x=${rootValue}*w/${designWidth};e.style.fontSize=x+\"px\"}else{w=${designWidth}/2;var x=${rootValue}*w/${designWidth};e.style.fontSize=x+\"px\"}}n.addEventListener(\"resize\",(function(){f()}));f()}(window);`\n        }\n        args[0].script = htmlScript\n        return args\n      })\n\n      // 修改h5平台的rule的正则表达式\n      chain.module\n        .rule('process-import-taro-h5')\n        .test(/(plugin|taro)-platform-harmony-hybrid[\\\\/]dist[\\\\/]api[\\\\/]apis[\\\\/]taro/)\n\n      // Note: 本地调试 stencil 组件库时，如果启用 sourceMap 则需要相关配置\n      chain.module\n        .rule('map')\n        .test(/\\.map$/)\n        .type('json')\n    })\n  }\n}\n","import H5 from './program'\n\nimport type { IPluginContext } from '@tarojs/service'\n\nexport { H5 }\n\nexport default (ctx: IPluginContext) => {\n  ctx.registerPlatform({\n    name: 'harmony-hybrid',\n    useConfigName: 'h5',\n    async fn ({ config }) {\n      const program = new H5(ctx, config)\n      await program.start()\n    },\n  })\n}\n\nexport * from './resolve'\n"],"names":["resolve","TaroPlatformWeb"],"mappings":"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"}