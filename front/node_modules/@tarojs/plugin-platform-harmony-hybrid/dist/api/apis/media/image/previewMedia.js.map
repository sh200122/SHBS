{"version":3,"file":"previewMedia.js","sources":["../../../../../src/api/apis/media/image/previewMedia.ts"],"sourcesContent":["import { SwiperProps } from '@tarojs/components'\nimport {\n  defineCustomElementTaroSwiperCore,\n  defineCustomElementTaroSwiperItemCore,\n} from '@tarojs/components/dist/components'\nimport { eventCenter } from '@tarojs/runtime'\nimport { isFunction } from '@tarojs/shared'\nimport Taro from '@tarojs/taro'\n\nimport { shouldBeObject } from '../../utils'\nimport { MethodHandler } from '../../utils/handler'\n\n/**\n * previewImage api基于开源的React组件[react-wx-images-viewer](https://github.com/react-ld/react-wx-images-viewer)开发，感谢！\n * 在新页面中全屏预览图片/视频。预览的过程中用户可以进行保存图片/视频、发送给朋友等操作。\n *\n * @canUse previewMedia\n * @__object [sources, current]\n */\nexport const previewMedia: typeof Taro.previewMedia = async (options) => {\n  // TODO 改为通过 window.__taroAppConfig 获取配置的 Swiper 插件创建节点\n  defineCustomElementTaroSwiperCore()\n  defineCustomElementTaroSwiperItemCore()\n\n  function loadImageAndVideo (sources: Taro.previewMedia.Sources, loadFail: typeof fail): Promise<Node> {\n    return new Promise((resolve) => {\n      const item = document.createElement('taro-swiper-item-core')\n      item.style.cssText = 'display:flex;align-items:start;justify-content:center;overflow-y:scroll;'\n      const image = new Image()\n      const video = document.createElement('video')\n      if (sources?.type === 'image') {\n        image.style.maxWidth = '100%'\n        image.src = sources?.url\n      } else {\n        video.style.maxWidth = '100%'\n        video.setAttribute('controls', 'controls')\n        const source = document.createElement('source')\n        source.src = sources?.url\n        video.appendChild(source)\n        video.poster = sources?.poster || ''\n      }\n      const div = document.createElement('div')\n      div.classList.add('swiper-zoom-container')\n      div.style.cssText = 'display:flex;align-items:center;justify-content:center;max-width:100%;min-height:100%;'\n      if (sources?.type === 'image') {\n        div.appendChild(image)\n      } else {\n        div.appendChild(video)\n      }\n      item.appendChild(div)\n      // Note: 等待图片加载完后返回，会导致轮播被卡住\n      resolve(item)\n      if (sources?.type === 'image' && isFunction(loadFail)) {\n        image.addEventListener('error', (err) => {\n          loadFail({ errMsg: err.message })\n        })\n      }\n    })\n  }\n\n  // options must be an Object\n  const isObject = shouldBeObject(options)\n  if (!isObject.flag) {\n    const res = { errMsg: `previewMedia:fail ${isObject.msg}` }\n    console.error(res.errMsg)\n    return Promise.reject(res)\n  }\n\n  const { sources = [], current = 0, success, fail, complete } = options\n  const handle = new MethodHandler({ name: 'previewMedia', success, fail, complete })\n  const container = document.createElement('div')\n  container.classList.add('preview-image')\n  container.style.cssText =\n    'position:fixed;top:0;left:0;z-index:1050;width:100%;height:100%;overflow:hidden;outline:0;background-color:#111;'\n\n  const removeHandler = () => {\n    eventCenter.off('__taroRouterChange', removeHandler)\n    container.remove()\n    eventCenter.trigger('__taroExitFullScreen', {})\n  }\n  container.addEventListener('click', removeHandler)\n\n  // 路由改变后应该关闭预览框\n  eventCenter.on('__taroRouterChange', removeHandler)\n\n  const swiper: HTMLElement & Omit<SwiperProps, 'style' | 'children'> = document.createElement('taro-swiper-core')\n  // @ts-ignore\n  swiper.full = true\n  // @ts-ignore\n  swiper.zoom = true\n\n  let children: Node[] = []\n  try {\n    children = await Promise.all(sources.map((e) => loadImageAndVideo(e, fail)))\n  } catch (error) {\n    return handle.fail({\n      errMsg: error,\n    })\n  }\n\n  for (let i = 0; i < children.length; i++) {\n    const child = children[i]\n    swiper.appendChild(child)\n  }\n\n  const currentIndex = current\n  // @ts-ignore\n  swiper.current = currentIndex\n\n  container.appendChild(swiper)\n  document.body.appendChild(container)\n  eventCenter.trigger('__taroEnterFullScreen', {})\n\n  return handle.success()\n}\n"],"names":[],"mappings":"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"}