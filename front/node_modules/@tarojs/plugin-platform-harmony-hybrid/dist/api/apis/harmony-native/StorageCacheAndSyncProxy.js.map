{"version":3,"file":"StorageCacheAndSyncProxy.js","sources":["../../../../src/api/apis/harmony-native/StorageCacheAndSyncProxy.ts"],"sourcesContent":["const TYPE_STORAGE_UPDATE_EVENT_CLEAR = 'TYPE_STORAGE_UPDATE_EVENT_CLEAR'\nclass ProxyHandler {\n  private cacheMap: Map<any, any>\n  private pageHasShowed: boolean = false\n  private pageShowUsedKeys: Set<string> = new Set<string>()\n\n  constructor (native: any) {\n    this.cacheMap = new Map<string, any>()\n\n    // 提前获取页面显示的storage\n    native.batchGetPageShowDataStorage({\n      fail: () => {},\n      success: (res) => {\n        for (let i = 1; i < res.keys.length; i++) {\n          this.cacheMap.set(res.keys[i], res.values[i])\n        }\n      }\n    })\n\n    // 页面全部加载完后，更新首屏使用到的Key\n    window.addEventListener('load', () => {\n      // 延时执行，下次的首屏会更快\n      setTimeout(() => {\n        this.pageHasShowed = true\n        native.updatePageShowDataKeys({\n          keys: Array.from(this.pageShowUsedKeys),\n          fail: () => {},\n          success: () => {}\n        })\n      }, 2000)\n    })\n\n    native.onStorageStatusChange((type: string, key: string) => {\n      if (type === TYPE_STORAGE_UPDATE_EVENT_CLEAR) {\n        this.cacheMap.clear()\n      } else {\n        this.cacheMap.delete(key)\n      }\n    })\n  }\n\n  get (target, propKey, receiver) {\n    const origMethod = Reflect.get(target, propKey, receiver)\n\n    if (propKey === 'getStorageSync') {\n      return (...args: any[]) => {\n        const key = args[0].key\n\n        if (!this.pageHasShowed) {\n          this.pageShowUsedKeys.add(key)\n        }\n\n        if (this.cacheMap.has(key)) {\n          return { errMsg: 'ok', data: this.cacheMap.get(key) }\n        } else {\n          const res = Reflect.apply(target[propKey], target, args)\n          if (res) {\n            // @ts-ignore\n            this.cacheMap.set(key, res?.data)\n          }\n          return res\n        }\n      }\n    }\n\n    if (propKey === 'setStorageSync') {\n      return (...args: any[]) => {\n        const key = args[0].key\n        const data = args[0].data\n        // 先更新js缓存，同异步原生，TODO 考虑失败的情况\n        this.cacheMap.set(key, data)\n\n        args[0].fail = () => {}\n        args[0].success = () => {}\n        Reflect.apply(target.setStorage, target, args)\n      }\n    }\n    if (propKey === 'removeStorageSync') {\n      return (...args: any[]) => {\n        const { key } = args[0]\n        // 先更新缓存，再同步原生\n        this.cacheMap.delete(key)\n\n        args[0].fail = () => {}\n        args[0].success = () => {}\n        Reflect.apply(target.removeStorage, target, args)\n        // this.nativeApi['removeStorage']({key: key})\n      }\n    }\n    if (propKey === 'clearStorageSync') {\n      return (...args: any[]) => {\n        // 先更新缓存，再同步原生\n        this.cacheMap.clear()\n\n        args[0].fail = () => {}\n        args[0].success = () => {}\n        Reflect.apply(target.clearStorage, target, args)\n      }\n    }\n\n    if (propKey === 'getStorage') {\n      return (...args: any[]) => {\n        const key = args[0].key\n        const success = args[0].success\n\n        if (!this.pageHasShowed) {\n          this.pageShowUsedKeys.add(key)\n        }\n\n        if (this.cacheMap.has(key)) {\n          success({ errMsg: 'ok', data: this.cacheMap.get(key) })\n        } else {\n          args[0].success = (res) => {\n            this.cacheMap.set(key, res.data)\n            success(res)\n          }\n          Reflect.apply(target[propKey], target, args)\n        }\n      }\n    }\n    if (propKey === 'setStorage') {\n      return (...args: any[]) => {\n        const key = args[0].key\n        const data = args[0].data\n        this.cacheMap.set(key, data)\n        // 同步更新原生\n        Reflect.apply(target[propKey], target, args)\n      }\n    }\n    if (propKey === 'removeStorage') {\n      return (...args: any[]) => {\n        const { key } = args[0]\n        // 先更新缓存，再同步原生\n        this.cacheMap.delete(key)\n        Reflect.apply(target[propKey], target, args)\n      }\n    }\n    return origMethod\n  }\n}\n\nexport function storageCacheAndSyncProxy (native: any): any {\n  return new Proxy(native, new ProxyHandler(native))\n}\n"],"names":[],"mappings":"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"}