{"version":3,"file":"canvasToTempFilePath.js","sources":["../../../../src/api/apis/canvas/canvasToTempFilePath.ts"],"sourcesContent":["import Taro from '@tarojs/api'\n\nimport { findDOM, shouldBeObject } from '../utils'\nimport { MethodHandler } from '../utils/handler'\n\n/**\n * 把当前画布指定区域的内容导出生成指定大小的图片。在 draw() 回调里调用该方法才能保证图片导出成功。\n */\nconst QUALITY = 1.0 // 图片质量，为1.0时和原图片质量一致\nconst DX = 0 // imageResource的左上角在目标 canvas 上 x 轴的位置\nconst DY = 0 // imageResource的左上角在目标 canvas 上 y 轴的位置\n\n/**\n * 把当前画布指定区域的内容导出生成指定大小的图片\n *\n * @canUse canvasToTempFilePath\n * @__object [canvas, canvasId, quality, destHeight, destWidth, fileType[jpg, png], height, width, x, y]\n * @__success [tempFilePath]\n */\nexport const canvasToTempFilePath: typeof Taro.canvasToTempFilePath = (options, inst) => {\n  const name = 'canvasToTempFilePath'\n  // options must be an Object\n  const isObject = shouldBeObject(options)\n  if (!isObject.flag) {\n    const res = { errMsg: `${name}:fail ${isObject.msg}` }\n    console.error(res.errMsg)\n    return Promise.reject(res)\n  }\n\n  const {\n    canvas,\n    canvasId,\n    quality = QUALITY,\n    destHeight = 0,\n    destWidth = 0,\n    fileType = 'png',\n    height = 0,\n    width = 0,\n    x = 0,\n    y = 0,\n    success,\n    fail,\n    complete,\n  } = options as Exclude<typeof options, undefined>\n\n  const handle = new MethodHandler({ name, success, fail, complete })\n\n  let inCanvas: HTMLCanvasElement | HTMLImageElement\n\n  // 创建一个新的canvas元素用于绘制导出的图片\n  const outCanvas = document.createElement('canvas')\n  const ctx = outCanvas.getContext('2d') as CanvasRenderingContext2D\n  if (!ctx) {\n    const res = { errMsg: `${name}:fail, Can't get 2D rendering context` }\n    console.error(res.errMsg)\n    return Promise.reject(res)\n  }\n\n  outCanvas.width = destWidth\n  outCanvas.height = destHeight\n\n  // 设置背景为白色\n  ctx.fillStyle = '#FFFFFF'\n  ctx.fillRect(0, 0, outCanvas.width, outCanvas.height)\n\n  return new Promise((resolve, reject) => {\n    if (canvas) {\n      // 如果传入了Canvas实例，则直接使用\n      const imgData = canvas.toDataURL('png', QUALITY)\n      inCanvas = new Image()\n      inCanvas.src = imgData\n      // 如果inCanvas是Image元素，需要等待图像加载完成后再绘制\n      inCanvas.onload = () => {\n        ctx.drawImage(inCanvas, x, y, width, height, DX, DY, destWidth, destHeight)\n        const dataURL = outCanvas.toDataURL(`image/${(fileType === 'jpg' ? 'jpeg' : fileType) || 'png'}`, quality)\n        handle.success({\n          tempFilePath: dataURL,\n        }, { resolve, reject })\n      }\n      inCanvas.onerror = () => {\n        const res = { errMsg: `${name}:fail Image failed to load` }\n        console.error(res.errMsg)\n        handle.fail(res, { resolve, reject })\n      }\n    } else if (canvasId) {\n      // 否则通过canvasId获取canvas元素\n      const el = findDOM(inst) as HTMLElement\n      inCanvas = el?.querySelector(`canvas[canvas-id=\"${canvasId}\"]`) as HTMLCanvasElement\n      if (!inCanvas) {\n        const res = { errMsg: `${name}:fail, Can't find canvas with id ${canvasId}` }\n        console.error(res.errMsg)\n        return Promise.reject(res)\n      } else {\n        ctx.drawImage(inCanvas, x, y, width, height, DX, DY, destWidth, destHeight)\n        const dataURL = outCanvas.toDataURL(`image/${(fileType === 'jpg' ? 'jpeg' : fileType) || 'png'}`, quality)\n        handle.success({\n          tempFilePath: dataURL,\n        }, { resolve, reject })\n      }\n    } else {\n      const res = { errMsg: `${name}:fail, canvasId or canvas is required` }\n      console.error(res.errMsg)\n      return Promise.reject(res)\n    }\n  })\n}\n"],"names":[],"mappings":"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"}