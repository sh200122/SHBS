{"version":3,"file":"nativeRequest.js","sources":["../../../../../src/api/apis/network/request/nativeRequest.ts"],"sourcesContent":["import Taro from '@tarojs/api'\nimport { isFunction } from '@tarojs/shared'\nimport { toByteArray } from 'base64-js'\n\nimport { NativeRequest } from '../../interface/NativeRequest'\nimport { getParameterError, shouldBeObject } from '../../utils'\n\nexport const _request = (options) => {\n  const name = 'request'\n\n  const isObject = shouldBeObject(options)\n  if (!isObject.flag) {\n    const res = { errMsg: `${name}:fail ${isObject.msg}` }\n    return Promise.reject(res)\n  }\n\n  const { url, success, fail, complete, method, dataType, ...otherOptions } = options as Exclude<typeof options, undefined>\n  if (typeof url !== 'string') {\n    const res = {\n      errMsg: getParameterError({\n        para: 'url',\n        correct: 'string',\n        wrong: url,\n      }),\n    }\n    isFunction(fail) && fail(res)\n    isFunction(complete) && complete(res)\n    return Promise.reject(res)\n  }\n\n  let task!: Taro.RequestTask<any>\n  const result: ReturnType<typeof Taro.request> = new Promise((resolve, reject) => {\n    const upperMethod = method ? method.toUpperCase() : method\n    task = NativeRequest.createRequestTask({\n      url,\n      method: upperMethod,\n      dataType,\n      ...otherOptions,\n      success: (res: any) => {\n        const result = {\n          data: res.data,\n          statusCode: res.statusCode,\n          header: res.header,\n          cookies: res.cookies,\n          errMsg: res.errMsg\n        }\n        // ���������Ƕ��������ݣ��򽫷���ֵת���� ArrayBuffer\n        if (res.isArrayBuffer && dataType === 'arraybuffer') {\n          result.data = toByteArray(res.data).buffer\n        }\n        isFunction(success) && success(result)\n        isFunction(complete) && complete(result)\n        resolve(result)\n      },\n      fail: (res: any) => {\n        isFunction(fail) && fail(res)\n        isFunction(complete) && complete(res)\n        reject(res)\n      },\n    })\n  }) as any\n\n  result.onHeadersReceived = task.onHeadersReceived.bind(task)\n  result.offHeadersReceived = task.offHeadersReceived.bind(task)\n  result.abort = task.abort.bind(task)\n  return result\n}\n\nfunction taroInterceptor (chain) {\n  return _request(chain.requestParams)\n}\n\n// @ts-ignore\nconst { Link } = Taro\nconst link = new Link(taroInterceptor)\n\n\nexport function request (options) {\n  const result = link.request.bind(link)(options)\n  result.catch(() => {})\n  return result\n}\n\n\nexport const addInterceptor = link.addInterceptor.bind(link)\n\n\nexport const cleanInterceptors = link.cleanInterceptors.bind(link)\n"],"names":[],"mappings":"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"}