{"version":3,"file":"download.js","sources":["../../../../src/api/apis/network/download.ts"],"sourcesContent":["import Taro from '@tarojs/api'\n\nimport native from '../NativeApi'\nimport { CallbackManager } from '../utils/handler'\nimport { NETWORK_TIMEOUT, setHeader, XHR_STATS } from './utils'\n\nconst splitHeaders = (headers: string) => {\n  const arr = headers.trim().split(/[\\r\\n]+/)\n  const headerMap = {}\n  arr.forEach((line) => {\n    const parts = line.split(': ')\n    if (parts.length === 2) {\n      headerMap[parts[0]] = parts[1]\n    }\n  })\n  return headerMap\n}\n\nconst createDownloadTask = ({\n  url,\n  header,\n  filePath,\n  withCredentials = true,\n  timeout,\n  success,\n  error,\n}): Taro.DownloadTask => {\n  let timeoutInter: ReturnType<typeof setTimeout>\n  let totalData = 0\n  const apiName = 'downloadFile'\n  const xhr = new XMLHttpRequest()\n  const callbackManager = {\n    headersReceived: new CallbackManager(),\n    progressUpdate: new CallbackManager(),\n  }\n\n  xhr.open('GET', url, true)\n  xhr.withCredentials = !!withCredentials\n  xhr.responseType = 'blob'\n  setHeader(xhr, header)\n\n  xhr.onprogress = (e) => {\n    const { loaded, total } = e\n    totalData = total\n    callbackManager.progressUpdate.trigger({\n      progress: Math.round((loaded / total) * 100),\n      totalBytesWritten: loaded,\n      totalBytesExpectedToWrite: total,\n    })\n  }\n\n  xhr.onreadystatechange = () => {\n    if (xhr.readyState !== XHR_STATS.HEADERS_RECEIVED) return\n    callbackManager.headersReceived.trigger({\n      header: splitHeaders(xhr.getAllResponseHeaders()),\n    })\n  }\n\n  xhr.onload = () => {\n    const response = xhr.response\n    const status = xhr.status\n    const reader = new FileReader()\n    reader.onload = () => {\n      clearTimeout(timeoutInter)\n      const base64Data = reader.result as string\n      native.saveDataUrlToFile({\n        filePath,\n        url,\n        data: base64Data,\n        success: (res) => {\n          const resData = {\n            errMsg: `${apiName}:ok`,\n            statusCode: status,\n            tempFilePath: res.tempFilePath,\n            dataLength: totalData,\n            header: splitHeaders(xhr.getAllResponseHeaders()),\n            cookies: [],\n          }\n          filePath && Object.assign(resData, { filePath })\n          success(resData)\n        },\n        fail: (res) => {\n          error({\n            errMsg: `${apiName}:fail ${res.errMsg}`,\n          })\n        },\n      })\n    }\n    reader.readAsDataURL(response)\n  }\n\n  xhr.onabort = () => {\n    clearTimeout(timeoutInter)\n    error({\n      errMsg: `${apiName}:fail abort`,\n    })\n  }\n\n  xhr.onerror = (e: ProgressEvent<EventTarget> & { message?: string }) => {\n    error({\n      errMsg: `${apiName}:fail ${e.message}`,\n    })\n  }\n\n  /**\n   * 中断任务\n   */\n  const abort = () => {\n    xhr.abort()\n  }\n\n  const send = () => {\n    xhr.send()\n    timeoutInter = setTimeout(() => {\n      xhr.onabort = null\n      xhr.onload = null\n      xhr.onprogress = null\n      xhr.onreadystatechange = null\n      xhr.onerror = null\n      abort()\n      error({\n        errMsg: `${apiName}:fail timeout`,\n      })\n    }, timeout || NETWORK_TIMEOUT)\n  }\n\n  send()\n\n  /**\n   * 监听 HTTP Response Header 事件。会比请求完成事件更早\n   * @param {HeadersReceivedCallback} callback HTTP Response Header 事件的回调函数\n   */\n  const onHeadersReceived = callbackManager.headersReceived.addUnique\n  /**\n   * 取消监听 HTTP Response Header 事件\n   * @param {HeadersReceivedCallback} callback HTTP Response Header 事件的回调函数\n   */\n  const offHeadersReceived = callbackManager.headersReceived.remove\n\n  /**\n   * 监听进度变化事件\n   * @param {ProgressUpdateCallback} callback HTTP Response Header 事件的回调函数\n   */\n  const onProgressUpdate = callbackManager.progressUpdate.addUnique\n  /**\n   * 取消监听进度变化事件\n   * @param {ProgressUpdateCallback} callback HTTP Response Header 事件的回调函数\n   */\n  const offProgressUpdate = callbackManager.progressUpdate.remove\n\n  return {\n    abort,\n    onHeadersReceived,\n    offHeadersReceived,\n    onProgressUpdate,\n    offProgressUpdate,\n  }\n}\n\n/**\n * 下载文件资源到本地。客户端直接发起一个 HTTPS GET 请求，返回文件的本地临时路径。使用前请注意阅读相关说明。\n * 注意：请在服务端响应的 header 中指定合理的 Content-Type 字段，以保证客户端正确处理文件类型。\n */\n\n/**\n * 下载文件资源到本地\n *\n * @canUse downloadFile\n * @__object [url, filePath, header, timeout, withCredentials]\n * @__success [filePath, statusCode, tempFilePath, header, dataLength, cookies, profile]\n */\nexport const downloadFile: typeof Taro.downloadFile = ({\n  url,\n  header,\n  filePath,\n  withCredentials,\n  timeout,\n  success,\n  fail,\n  complete,\n}) => {\n  let task!: Taro.DownloadTask\n  const result: ReturnType<typeof Taro.downloadFile> = new Promise((resolve, reject) => {\n    task = createDownloadTask({\n      url,\n      header,\n      filePath,\n      withCredentials,\n      timeout,\n      success: (res) => {\n        success && success(res)\n        complete && complete(res)\n        resolve(res)\n      },\n      error: (res) => {\n        fail && fail(res)\n        complete && complete(res)\n        reject(res)\n      },\n    })\n  }) as any\n\n  result.headersReceive = task.onHeadersReceived\n  result.progress = task.onProgressUpdate\n\n  return new Proxy(result, {\n    get (target, prop) {\n      const object = prop in task ? task : target\n      const value = object[prop]\n      return typeof value === 'function' ? value.bind(object) : value\n    },\n  })\n}\n"],"names":[],"mappings":"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"}