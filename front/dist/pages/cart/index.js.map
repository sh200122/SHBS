{"version":3,"file":"pages/cart/index.js","mappings":";;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://myApp/./src/pages/cart/index.tsx?4a72","webpack://myApp/._src_pages_cart_index.tsx"],"sourcesContent":["import Header from \"@/components/Header\";\nimport Footer from \"@/components/Footer\";\nimport { View, ScrollView, Image, Text, Button } from \"@tarojs/components\";\nimport { useEffect, useState } from \"react\";\nimport Taro from \"@tarojs/taro\";\nimport { useDidShow } from \"@tarojs/taro\";\nimport { jsx as _jsx, jsxs as _jsxs } from \"react/jsx-runtime\";\nexport default function index() {\n  const [cartItems, setCartItems] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [isModalVisible, setIsModalVisible] = useState(false);\n  const fetchCartItems = async () => {\n    try {\n      const response = await Taro.request({\n        url: \"http://localhost:5000/api/cart\",\n        method: \"GET\",\n        header: {\n          Authorization: `Bearer ${Taro.getStorageSync(\"token\")}`\n        }\n      });\n\n      // 确保返回的数据存在且有items数组\n      if (response.data && response.data.items) {\n        setCartItems(response.data.items);\n      } else {\n        setCartItems([]);\n      }\n    } catch (error) {\n      console.error(\"获取购物车失败:\", error);\n      Taro.showToast({\n        title: \"获取购物车失败\",\n        icon: \"error\"\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n  useEffect(() => {\n    fetchCartItems();\n  }, []);\n  useDidShow(() => {\n    fetchCartItems();\n  });\n  if (loading) {\n    return /*#__PURE__*/_jsxs(View, {\n      className: \"min-h-screen\",\n      children: [/*#__PURE__*/_jsx(Header, {}), /*#__PURE__*/_jsx(View, {\n        className: \"flex items-center justify-center h-[84%]\",\n        children: /*#__PURE__*/_jsx(Text, {\n          children: \"\\u52A0\\u8F7D\\u4E2D...\"\n        })\n      }), /*#__PURE__*/_jsx(Footer, {})]\n    });\n  }\n  const updateQuantity = async (productId, newQuantity) => {\n    if (newQuantity < 1) return;\n    try {\n      const response = await Taro.request({\n        url: \"http://localhost:5000/api/cart/update\",\n        method: \"PUT\",\n        header: {\n          Authorization: `Bearer ${Taro.getStorageSync(\"token\")}`\n        },\n        data: {\n          productId,\n          quantity: newQuantity\n        }\n      });\n      if (response.data && response.data.items) {\n        setCartItems(response.data.items);\n      }\n    } catch (error) {\n      Taro.showToast({\n        title: \"更新数量失败\",\n        icon: \"error\"\n      });\n    }\n  };\n  const removeItem = async productId => {\n    try {\n      const response = await Taro.request({\n        url: \"http://localhost:5000/api/cart/remove\",\n        method: \"DELETE\",\n        header: {\n          Authorization: `Bearer ${Taro.getStorageSync(\"token\")}`\n        },\n        data: {\n          productId\n        }\n      });\n      if (response.data && response.data.items) {\n        setCartItems(response.data.items);\n      }\n    } catch (error) {\n      Taro.showToast({\n        title: \"删除商品失败\",\n        icon: \"error\"\n      });\n    }\n  };\n  const handlePay = () => {\n    const token = Taro.getStorageSync(\"token\");\n    if (!token) {\n      Taro.showToast({\n        title: \"请先登录\",\n        icon: \"error\",\n        duration: 2000\n      });\n      return;\n    }\n    setIsModalVisible(true);\n  };\n  const confirmOrder = async () => {\n    try {\n      const token = Taro.getStorageSync(\"token\");\n      // 构建订单商品数据\n      const orderProducts = cartItems.map(item => ({\n        productId: item.productId._id,\n        quantity: item.quantity\n      }));\n      const response = await Taro.request({\n        url: \"http://localhost:5000/api/orders/create\",\n        method: \"POST\",\n        data: {\n          products: orderProducts\n        },\n        header: {\n          Authorization: `Bearer ${token}`\n        }\n      });\n      if (response.data.success) {\n        // 清空购物车\n        const clearCartResponse = await Taro.request({\n          url: \"http://localhost:5000/api/cart/clear\",\n          method: \"POST\",\n          header: {\n            Authorization: `Bearer ${token}`\n          }\n        });\n        if (clearCartResponse.data.success) {\n          setCartItems([]); // 清空本地购物车数据\n        }\n        Taro.showToast({\n          title: \"下单成功\",\n          icon: \"success\",\n          duration: 2000\n        });\n        Taro.reLaunch({\n          url: \"/pages/cart/index\"\n        });\n      } else {\n        throw new Error(response.data.message || \"下单失败\");\n      }\n    } catch (error) {\n      console.error(\"下单错误:\", error);\n      Taro.showToast({\n        title: error.message || \"下单失败\",\n        icon: \"error\",\n        duration: 2000\n      });\n    }\n    setIsModalVisible(false);\n  };\n\n  // 计算总金额\n  const totalAmount = cartItems.reduce((sum, item) => sum + item.productId.price * item.quantity, 0).toFixed(2);\n  return /*#__PURE__*/_jsxs(View, {\n    className: \"min-h-screen\",\n    children: [/*#__PURE__*/_jsx(Header, {}), /*#__PURE__*/_jsx(ScrollView, {\n      className: \"fixed top-[11%] h-[84%] bg-gray-100 w-full p-3\",\n      scrollY: true,\n      enableFlex: true,\n      children: cartItems.length === 0 ? /*#__PURE__*/_jsx(View, {\n        className: \"flex items-center justify-center h-full\",\n        children: /*#__PURE__*/_jsx(Text, {\n          children: \"\\u8D2D\\u7269\\u8F66\\u662F\\u7A7A\\u7684\"\n        })\n      }) : cartItems.map(item => /*#__PURE__*/_jsxs(View, {\n        className: \"flex items-center justify-between bg-white p-4 mb-2 rounded-lg w-[94%]\",\n        children: [/*#__PURE__*/_jsx(Image, {\n          src: item.productId.image,\n          className: \"w-20 h-20 rounded-md object-cover\"\n        }), /*#__PURE__*/_jsx(View, {\n          className: \"flex-1 ml-4\",\n          children: /*#__PURE__*/_jsxs(View, {\n            className: \"flex flex-col gap-y-2\",\n            children: [/*#__PURE__*/_jsx(Text, {\n              className: \"text-lg font-medium\",\n              children: item.productId.name\n            }), /*#__PURE__*/_jsx(Text, {\n              className: \"text-sm text-gray-500\",\n              children: item.productId.description\n            }), /*#__PURE__*/_jsxs(Text, {\n              className: \"text-red-500\",\n              children: [\"\\xA5\", item.productId.price]\n            })]\n          })\n        }), /*#__PURE__*/_jsxs(View, {\n          className: \"flex flex-col items-center gap-y-2\",\n          children: [/*#__PURE__*/_jsxs(View, {\n            className: \"flex items-center space-x-2 gap-2 w-24\",\n            children: [/*#__PURE__*/_jsx(Button, {\n              className: \"bg-gray-200 rounded w-6 h-6 flex items-center justify-center\",\n              onClick: () => updateQuantity(item.productId._id, item.quantity - 1),\n              children: /*#__PURE__*/_jsx(Text, {\n                className: \"text-sm\",\n                children: \" - \"\n              })\n            }), /*#__PURE__*/_jsx(Text, {\n              children: item.quantity\n            }), /*#__PURE__*/_jsx(Button, {\n              className: \"bg-gray-200 rounded w-6 h-6 flex items-center justify-center\",\n              onClick: () => updateQuantity(item.productId._id, item.quantity + 1),\n              children: /*#__PURE__*/_jsx(Text, {\n                className: \"text-sm\",\n                children: \" + \"\n              })\n            })]\n          }), /*#__PURE__*/_jsx(Button, {\n            className: \"bg-red-500 text-white px-2 rounded\",\n            \"hover-class\": \"bg-red-800\",\n            onClick: () => removeItem(item.productId._id),\n            children: \"\\u5220\\u9664\"\n          })]\n        })]\n      }, item.productId._id))\n    }), cartItems.length > 0 && /*#__PURE__*/_jsxs(View, {\n      className: \"fixed bottom-[5%] left-0 right-0 bg-white p-4 flex justify-between items-center w-full rounded-lg\",\n      children: [/*#__PURE__*/_jsxs(Text, {\n        className: \"text-lg\",\n        children: [\"\\u603B\\u8BA1: \\xA5\", totalAmount]\n      }), /*#__PURE__*/_jsx(Button, {\n        className: \"bg-yellow-500 text-white rounded mr-1\",\n        \"hover-class\": \"bg-yellow-800\",\n        onClick: handlePay,\n        children: \"\\u7ED3\\u7B97\"\n      })]\n    }), isModalVisible && /*#__PURE__*/_jsx(View, {\n      className: \"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\",\n      children: /*#__PURE__*/_jsxs(View, {\n        className: \"bg-white rounded-lg p-6 w-[80%] max-h-[80%] overflow-y-auto\",\n        children: [/*#__PURE__*/_jsx(Text, {\n          className: \"text-xl font-bold mb-4\",\n          children: \"\\u786E\\u8BA4\\u8BA2\\u5355\"\n        }), /*#__PURE__*/_jsx(ScrollView, {\n          scrollY: true,\n          className: \"max-h-64 my-4\",\n          children: cartItems.map(item => /*#__PURE__*/_jsxs(View, {\n            className: \"flex items-center py-2 pr-4 border-b border-gray-100\",\n            children: [/*#__PURE__*/_jsx(Image, {\n              src: item.productId.image,\n              className: \"w-12 h-12 rounded-md object-cover\"\n            }), /*#__PURE__*/_jsxs(View, {\n              className: \"ml-3 flex-1\",\n              children: [/*#__PURE__*/_jsx(Text, {\n                className: \"font-medium\",\n                children: item.productId.name\n              }), /*#__PURE__*/_jsxs(View, {\n                className: \"flex justify-between mt-1\",\n                children: [/*#__PURE__*/_jsxs(Text, {\n                  className: \"text-red-500\",\n                  children: [\"\\xA5\", item.productId.price]\n                }), /*#__PURE__*/_jsxs(Text, {\n                  className: \"text-gray-500\",\n                  children: [\"x\", item.quantity]\n                })]\n              })]\n            })]\n          }, item.productId._id))\n        }), /*#__PURE__*/_jsxs(View, {\n          className: \"border-t border-gray-200 pt-4\",\n          children: [/*#__PURE__*/_jsxs(Text, {\n            className: \"font-bold text-lg mb-4\",\n            children: [\"\\u603B\\u8BA1: \\xA5\", totalAmount]\n          }), /*#__PURE__*/_jsxs(View, {\n            className: \"flex justify-between mt-4\",\n            children: [/*#__PURE__*/_jsx(Button, {\n              className: \"bg-gray-300 text-gray-700 rounded w-[45%]\",\n              onClick: () => setIsModalVisible(false),\n              children: \"\\u53D6\\u6D88\"\n            }), /*#__PURE__*/_jsx(Button, {\n              className: \"bg-yellow-500 text-white rounded w-[45%]\",\n              \"hover-class\": \"bg-yellow-600\",\n              onClick: confirmOrder,\n              children: \"\\u786E\\u8BA4\\u652F\\u4ED8\"\n            })]\n          })]\n        })]\n      })\n    }), /*#__PURE__*/_jsx(Footer, {})]\n  });\n}","import { createPageConfig } from '@tarojs/runtime'\nimport component from \"!!../../../node_modules/@tarojs/taro-loader/lib/entry-cache.js?name=pages/cart/index!./index.tsx\"\nvar config = {};\n\n\n\nvar taroOption = createPageConfig(component, 'pages/cart/index', {root:{cn:[]}}, config || {})\nif (component && component.behaviors) {\n  taroOption.behaviors = (taroOption.behaviors || []).concat(component.behaviors)\n}\nvar inst = Page(taroOption)\n\n\n\nexport default component\n"],"names":[],"sourceRoot":""}